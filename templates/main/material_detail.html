{% extends 'base.html' %}
{% block title %}Dars Tafsiloti{% endblock %}

{% block content %}
<h2 class="mb-4">{{ category.name }}</h2>

{% for material in materials %}
<div class="card mb-4 shadow-sm">
    <div class="card-body">
        <h5 class="card-title">ðŸ“š Dars: {{ material.title }}</h5>

        {% if material.text %}
        <div class="mb-3">
            <h6>ðŸ“– Matn:</h6>
            <p>{{ material.text|linebreaks }}</p>
        </div>
        {% endif %}

        {% if material.audio %}
        <div class="mb-3">
            <h6>ðŸ”Š Audio:</h6>
            <audio
                id="audio-{{ material.id }}"
                class="w-100 material-audio"
                controls
                data-material-id="{{ material.id }}">
                <source src="{{ material.audio.url }}" type="audio/mpeg">
                Brauzeringiz audiolarni qoâ€˜llab-quvvatlamaydi.
            </audio>
        </div>
        {% endif %}

        {% if material.assignment_text or material.assignment_audio or material.assignment_image %}
        <div class="mb-3">
            <h6>ðŸ“Œ Topshiriq:</h6>

            {% if material.assignment_text %}
                <p>{{ material.assignment_text }}</p>
            {% endif %}

            {% if material.assignment_audio %}
                <p><strong>Audio:</strong></p>
                <audio controls class="w-100">
                    <source src="{{ material.assignment_audio.url }}" type="audio/mpeg">
                    Brauzeringiz audiolarni qoâ€˜llab-quvvatlamaydi.
                </audio>
            {% endif %}

            {% if material.assignment_image %}
                <p><strong>Rasm:</strong></p>
                <img src="{{ material.assignment_image.url }}" alt="Topshiriq rasmi" class="img-fluid rounded">
            {% endif %}
        </div>
        {% endif %}

        <div id="completion-alert-{{ material.id }}" class="alert alert-success {% if material.is_completed %}d-block{% else %}d-none{% endif %}">
            âœ… Tugallandi!
        </div>
    </div>
</div>
{% endfor %}

<script>
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('audio.material-audio').forEach(audio => {
        audio.addEventListener('ended', function () {
            const materialId = audio.dataset.materialId;
            fetch(`/material/${materialId}/complete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    const alertBox = document.getElementById('completion-alert-' + materialId);
                    if (alertBox) {
                        alertBox.classList.remove('d-none');
                    }
                }
            });
        });
    });
});
</script>
{% endblock %}
