{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}{% trans "Kmodi.uz" %}{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">

  <style>
    body {
      background: linear-gradient(to right, #faf8af, #ffa6fa);
      font-family: "Segoe UI", sans-serif;
    }
    .navbar {
      background: linear-gradient(to right, #faf8af, #ffa6fa);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .navbar-brand {
      font-weight: bold;
      font-size: 1.5rem;
      color: black !important;
    }
    .navbar-nav .nav-link {
      font-weight: 500;
      margin: 0 10px;
      border: 1px solid black;
      border-radius: 15px;
      padding: 7px 20px;
      background: linear-gradient(to right, #faf8af, #ffa6fa);
      color: black !important;
      transition: 0.3s;
    }
    .form-control {
      border-radius: 25px;
      border: 1px solid #aaa;
      padding: 12px 20px;
      font-size: 1rem;
      min-width: 280px;
    }
    .btn-outline-light {
      border-radius: 25px;
      background: linear-gradient(to right, #faf8af, #ffa6fa);
      color: black;
      border: 1px solid black;
      font-weight: bold;
      padding: 8px 20px;
    }
    .btn-outline-light:hover {
      background: linear-gradient(to right, #ffe680, #ff85ea);
      color: black;
    }
    .navbar-toggler {
      border: none;
    }
    .navbar-toggler-icon {
      background-image: url("data:image/svg+xml;charset=utf8,%3Csvg viewBox='0 0 30 30' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath stroke='black' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3E%3C/svg%3E");
    }
    .lang-buttons {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: 15px;
    }
    .lang-buttons button {
      border: 1px solid black;
      border-radius: 15px;
      padding: 4px 10px;
      background: linear-gradient(to right, #faf8af, #ffa6fa);
      color: black;
      font-weight: 500;
    }
    footer {
      background: linear-gradient(to right, #faf8af, #ffa6fa);
    }

    .highlight-read {
      outline: 3px solid orange;
      background-color: rgba(255, 255, 0, 0.3);
      transition: background 0.3s, outline 0.3s;
    }

    .sr-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      border: 2px solid #222;
      border-radius: 30px;
      padding: 10px 20px;
      background-color: #fff4a3;
      color: #000;
      font-weight: bold;
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
      cursor: pointer;
    }
  </style>

  {% block extra_head %}{% endblock %}
</head>

<body class="d-flex flex-column min-vh-100">

<button id="screenReaderToggle" class="sr-button">üîä {% trans "Screen Reader" %}</button>

<nav class="navbar navbar-expand-lg sticky-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="{% url 'home' %}">{% trans "Kmodi.uz" %}</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="{% trans 'Toggle navigation' %}">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <form class="d-flex ms-3 me-auto" role="search" method="get" action="{% url 'search' %}">
        <input class="form-control me-2" type="search" name="q" placeholder="{% trans 'Search...' %}" aria-label="{% trans 'Search' %}" value="{{ request.GET.q|default_if_none:'' }}">
        <button class="btn btn-outline-light" type="submit">üîç</button>
      </form>

      <form action="{% url 'set_language' %}" method="post" class="lang-buttons">
        {% csrf_token %}
        <input name="next" type="hidden" value="{{ request.path }}">
        <button type="submit" name="language" value="uz">{% trans "UZ" %}</button>
        <button type="submit" name="language" value="ru">{% trans "RU" %}</button>
        <button type="submit" name="language" value="en">{% trans "ENG" %}</button>
      </form>

      <ul class="navbar-nav ms-4 mt-2 mt-lg-0">
        <li class="nav-item">
          <a class="nav-link" href="{% url 'home' %}#ebooks">{% trans "E-Library" %}</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'home' %}#team">{% trans "Project Team" %}</a>
        </li>
        {% if user.is_authenticated %}
          <li class="nav-item">
            <a class="nav-link" href="{% url 'profile' %}">{% trans "Profile" %}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'logout' %}">{% trans "Logout" %}</a>
          </li>
        {% else %}
          <li class="nav-item">
            <a class="nav-link" href="{% url 'login' %}">{% trans "Login" %}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'register' %}">{% trans "Register" %}</a>
          </li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

<main class="container py-4">{% block content %}{% endblock %}</main>

<footer class="text-white text-center py-3 mt-auto">
  <div class="container">
    <p class="mb-0" style="color: black;">&copy; 2025 kmodi.uz ‚Äî {% trans "All rights reserved." %}</p>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const srToggleBtn = document.getElementById('screenReaderToggle');
  const synth = window.speechSynthesis;
  let voices = [];
  const lang = "{{ LANGUAGE_CODE }}";
  const targetsSelector = "a, button, input, label, textarea, p, h1, h2, h3, h4, h5, h6, span, div";
  let screenReaderEnabled = localStorage.getItem('screenReader') === 'on';

  function loadVoices() { voices = synth.getVoices(); }
  window.speechSynthesis.onvoiceschanged = loadVoices;

  function getVoice(langCode) {
    loadVoices();
    if (langCode === 'uz') return voices.find(v => v.lang.startsWith('tr')) || voices.find(v => v.lang.startsWith('en'));
    if (langCode === 'ru') return voices.find(v => v.lang.startsWith('ru'));
    if (langCode === 'en') return voices.find(v => v.lang.startsWith('en'));
    return voices[0];
  }

  function cleanText(text) {
    return text.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F6FF}\u{1F900}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]+/gu, '')
               .replace(/[^a-zA-Z0-9\s.,?!\u0400-\u04FF\u0600-\u06FF\u0C00-\u0C7F\u1000-\u109F]/g, '');
  }

  function speak(text) {
    const cleaned = cleanText(text);
    if (!cleaned.trim()) return;
    const utter = new SpeechSynthesisUtterance(cleaned);
    const voice = getVoice(lang);
    if (voice) {
      utter.voice = voice;
      utter.lang = voice.lang;
    }
    utter.pitch = 1;
    utter.rate = 1;
    synth.cancel();
    synth.speak(utter);
  }

  function handleHoverSpeak(e) {
    const el = e.target;
    const prev = document.querySelector('.highlight-read');
    if (prev && prev !== el) prev.classList.remove("highlight-read");
    el.classList.add("highlight-read");

    const text = el.innerText || el.alt || el.title || el.ariaLabel || el.value;
    if (text && text.trim()) {
      speak(text);
    }

    setTimeout(() => el.classList.remove("highlight-read"), 1500);
  }

  function handleTextSelect() {
    const selected = window.getSelection().toString().trim();
    if (selected.length > 2) speak(selected);
  }

  function addListeners() {
    if (!screenReaderEnabled) return;
    document.querySelectorAll(targetsSelector).forEach((el) => {
      if (!el.classList.contains('sr-listened')) {
        el.addEventListener('mouseenter', handleHoverSpeak);
        el.addEventListener('focus', handleHoverSpeak);
        el.classList.add('sr-listened');
      }
    });
  }

  function removeListeners() {
    document.querySelectorAll(targetsSelector).forEach((el) => {
      el.removeEventListener("mouseenter", handleHoverSpeak);
      el.removeEventListener("focus", handleHoverSpeak);
      el.classList.remove("sr-listened");
      el.classList.remove("highlight-read");
    });
  }

  function updateToggleText() {
    srToggleBtn.style.backgroundColor = screenReaderEnabled ? "#00cc66" : "#fff4a3";
    srToggleBtn.innerText = screenReaderEnabled
      ? "üü¢ {{ _('Screen Reader On') }}"
      : "üîä {{ _('Screen Reader') }}";
  }

  srToggleBtn.addEventListener("click", () => {
    screenReaderEnabled = !screenReaderEnabled;
    localStorage.setItem('screenReader', screenReaderEnabled ? 'on' : 'off');
    updateToggleText();

    if (screenReaderEnabled) {
      addListeners();
      document.addEventListener("mouseup", handleTextSelect);
    } else {
      removeListeners();
      document.removeEventListener("mouseup", handleTextSelect);
    }
  });

  new MutationObserver(() => {
    if (screenReaderEnabled) addListeners();
  }).observe(document.body, { childList: true, subtree: true });

  // INIT on page load if screenReader = 'on'
  window.addEventListener("DOMContentLoaded", () => {
    updateToggleText();
    if (screenReaderEnabled) {
      addListeners();
      document.addEventListener("mouseup", handleTextSelect);
    }
  });
</script>

{% block extra_js %}{% endblock %}
</body>
</html>